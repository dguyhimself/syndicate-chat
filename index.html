<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Syndicate [Community Hub v12.0 FINAL]</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;700&family=Teko:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* CSS remains largely the same, with minor additions for the new inputs */
        :root {
            --background-color: #0A0F14;
            --primary-color: rgba(22, 27, 34, 0.7);
            --secondary-color: rgba(34, 40, 49, 0.8);
            --accent-color: #00ff9d;
            --glow-color: rgba(0, 255, 157, 0.5);
            --text-color: #E6EDF3;
            --text-muted-color: #8B949E;
            --danger-color: #F85149;
            --success-color: #3FB950;
            --border-color: rgba(139, 148, 158, 0.2);
            --font-family-mono: 'Roboto Mono', monospace;
            --font-family-display: 'Teko', sans-serif;
            --border-radius: 8px;
            --transition-speed: 0.3s;
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            scrollbar-width: thin; scrollbar-color: var(--accent-color) var(--primary-color);
        }
        *::-webkit-scrollbar { width: 8px; }
        *::-webkit-scrollbar-track { background: transparent; }
        *::-webkit-scrollbar-thumb { background-color: var(--accent-color); border-radius: 20px; }

        body {
            font-family: var(--font-family-mono); background-color: var(--background-color); color: var(--text-color);
            display: flex; overflow: hidden;
            background-image:
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 25px 25px; background-attachment: fixed;
        }
        body::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(10, 15, 20, 0) 0%, rgba(10, 15, 20, 0.8) 75%, rgb(10, 15, 20) 100%);
            z-index: -1;
        }

        /* --- Login Overlay --- */
        #antechamber {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(10, 15, 20, 0.8); display: flex; justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(10px); transition: opacity 0.5s ease, visibility 0.5s;
        }
        .login-box {
            background: rgba(13, 17, 23, 0.6); border: 1px solid var(--border-color);
            padding: 40px; text-align: center; width: 450px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(15px); border-radius: var(--border-radius); animation: fadeIn 1s ease;
        }
        .login-box h1 { font-family: var(--font-family-display); color: var(--accent-color); font-size: 5rem; margin-bottom: 0px; letter-spacing: 5px; line-height: 1; text-shadow: 0 0 20px var(--glow-color); }
        .login-box p { color: var(--text-muted-color); margin-bottom: 30px; letter-spacing: 1px; text-transform: uppercase; }
        .login-box .form-group { margin-bottom: 20px; }
        .login-box input { width: 100%; padding: 15px; background-color: var(--background-color); border: 1px solid var(--border-color); color: var(--text-color); font-family: var(--font-family-mono); font-size: 1rem; text-align: center; transition: all var(--transition-speed) ease; border-radius: 4px; }
        .login-box input:focus { border-color: var(--accent-color); box-shadow: 0 0 10px var(--glow-color); outline: none; }
        #enterSyndicateBtn { width: 100%; padding: 18px; background-color: var(--accent-color); border: none; color: var(--background-color); font-family: var(--font-family-display); font-size: 1.8rem; letter-spacing: 2px; cursor: pointer; transition: all var(--transition-speed) ease; border-radius: 4px; }
        #enterSyndicateBtn:hover { box-shadow: 0 0 25px var(--glow-color); background-color: #fff; transform: translateY(-3px); letter-spacing: 3px; }
        #login-error { color: var(--danger-color); margin-top: 15px; display: block; font-size: 0.9rem; min-height: 1.2rem; }
        .login-toggle { margin-top: 25px; }
        .login-toggle a { color: var(--text-muted-color); text-decoration: none; font-size: 0.9rem; transition: color var(--transition-speed); }
        .login-toggle a:hover { color: var(--accent-color); }

        /* Other styles are unchanged, add the rest of the original CSS here... */
        #sidebar { width: 70px; background-color: var(--primary-color); border-right: 1px solid var(--border-color); padding: 20px 0; height: 100vh; display: flex; flex-direction: column; align-items: center; transition: width var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1); backdrop-filter: blur(15px); z-index: 10; overflow-x: hidden; }
        #sidebar:hover { width: 240px; }
        #sidebar .logo { font-family: var(--font-family-display); font-size: 3rem; color: var(--accent-color); margin-bottom: 40px; cursor: default; filter: drop-shadow(0 0 10px var(--glow-color)); }
        #sidebar nav ul { list-style: none; width: 100%; padding: 0; }
        #sidebar nav li { display: flex; align-items: center; padding: 15px 0; margin: 5px 0; cursor: pointer; border-left: 4px solid transparent; transition: all var(--transition-speed) ease; white-space: nowrap; position: relative; }
        @keyframes pulse-border { 0% { border-left-color: var(--accent-color); } 50% { border-left-color: var(--glow-color); } 100% { border-left-color: var(--accent-color); } }
        #sidebar nav li.active { border-left-color: var(--accent-color); animation: pulse-border 2s infinite; }
        #sidebar nav li.active, #sidebar nav li:hover { background-color: var(--secondary-color); }
        #sidebar nav li .icon { font-size: 1.5rem; min-width: 70px; display: flex; justify-content: center; transition: transform var(--transition-speed) ease; }
        #sidebar nav li.active .icon, #sidebar nav li:hover .icon { filter: drop-shadow(0 0 8px var(--glow-color)); color: var(--accent-color); }
        #sidebar .nav-text { margin-left: 10px; font-weight: 500; opacity: 0; transition: opacity 0.2s ease; }
        #sidebar:hover .nav-text { opacity: 1; transition-delay: 0.1s; }
        .user-profile { margin-top: auto; padding: 20px 0; width: 100%; text-align: center; white-space: nowrap; overflow: hidden; border-top: 1px solid var(--border-color); }
        .user-details { opacity: 0; transition: opacity 0.3s ease 0.1s, transform 0.3s ease; height: 0; transform: translateY(10px); }
        #sidebar:hover .user-details { opacity: 1; height: auto; transform: translateY(0); }
        #usernameDisplay { font-size: 1rem; font-weight: bold; margin-bottom: 8px; }
        .rank { padding: 4px 10px; font-weight: bold; display: inline-block; margin-bottom: 10px; font-size: 0.8rem; border-radius: 4px; text-transform: uppercase; letter-spacing: 1px; border: 1px solid; }
        #status { font-size: 0.8rem; color: var(--accent-color); }
        #status::before { content: "‚óè"; margin-right: 6px; }
        .rank.architect { background-color: var(--accent-color); color: var(--background-color); border-color: var(--accent-color); }
        .rank.enforcer { background-color: transparent; color: var(--danger-color); border-color: var(--danger-color); }
        .rank.artificer, .rank.scribe { background-color: transparent; color: #6F86FF; border-color: #6F86FF; }
        .rank.signal-corps { background-color: transparent; color: #FFB86C; border-color: #FFB86C; }
        .rank.sentinel { background-color: transparent; color: #A4B2FF; border-color: #A4B2FF; }
        .rank.soldier { background-color: transparent; color: var(--text-muted-color); border-color: var(--text-muted-color); }
        #main-content { flex: 1; padding: 40px; height: 100vh; overflow-y: auto; position: relative; }
        .view { display: none; animation: fadeIn 0.5s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        h2 { font-family: var(--font-family-display); font-size: 3.5rem; margin-bottom: 30px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; color: var(--text-color); letter-spacing: 1.5px; text-transform: uppercase; }
        h2 .highlight { color: var(--accent-color); }
        .card { background-color: var(--primary-color); border: 1px solid var(--border-color); padding: 25px; border-radius: var(--border-radius); backdrop-filter: blur(10px); box-shadow: 0 4px 20px rgba(0,0,0,0.3); transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease; position: relative; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 30px rgba(0,0,0,0.5), 0 0 15px rgba(0, 255, 157, 0.1); border-color: rgba(0, 255, 157, 0.2); }
        .card .card-header { font-family: var(--font-family-display); font-size: 2rem; color: var(--accent-color); margin-bottom: 15px; }
        .card .card-content { color: var(--text-muted-color); line-height: 1.7; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 30px; }
        #invite-code-widget { position: absolute; top: 45px; right: 40px; background-color: var(--secondary-color); padding: 8px 12px; border-radius: var(--border-radius); border: 1px solid var(--border-color); display: flex; align-items: center; gap: 12px; z-index: 5; transition: all var(--transition-speed) ease; }
        #invite-code-widget:hover { background-color: var(--primary-color); transform: scale(1.02); }
        #invite-code-widget span { font-family: var(--font-family-mono); font-size: 1rem; color: var(--text-muted-color); }
        #invite-code-widget strong { color: var(--accent-color); }
        #copy-invite-btn { background: transparent; border: none; cursor: pointer; color: var(--accent-color); transition: all var(--transition-speed) ease; }
        #copy-invite-btn:hover { color: #fff; transform: scale(1.1); }
        #copy-invite-btn svg { width: 20px; height: 20px; }
        #copy-invite-btn .copy-text { font-family: var(--font-family-mono); font-size: 0.9rem; }
        .lounge-container { display: flex; height: calc(100vh - 180px); background: var(--primary-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); overflow: hidden; }
        .channel-list { width: 250px; border-right: 1px solid var(--border-color); padding: 15px; background-color: rgba(0,0,0,0.1); }
        .channel-list h3 { font-family: var(--font-family-display); font-size: 1.8rem; margin-bottom: 15px; padding: 10px; }
        .channel-list ul { list-style: none; }
        .channel-list li { display: flex; align-items: center; padding: 12px 15px; border-radius: 5px; margin-bottom: 5px; cursor: pointer; transition: background-color var(--transition-speed); }
        .channel-list li::before { content: '#'; margin-right: 10px; color: var(--text-muted-color); }
        .channel-list li.active, .channel-list li:hover { background-color: var(--secondary-color); color: var(--accent-color); }
        .channel-list li.active::before, .channel-list li:hover::before { color: var(--accent-color); }
        .chat-area { flex: 1; display: flex; flex-direction: column; }
        .chat-header { padding: 20px; border-bottom: 1px solid var(--border-color); font-weight: bold; background-color: rgba(0,0,0,0.1);}
        #current-channel-name { color: var(--accent-color); font-family: var(--font-family-mono); }
        .chat-messages { flex-grow: 1; padding: 20px; overflow-y: auto; }
        #typing-indicator { height: 25px; padding: 0 20px; color: var(--text-muted-color); font-style: italic; transition: opacity 0.3s ease; }
        .message { margin-bottom: 20px; display: flex; animation: fadeInMessage 0.3s ease; }
        @keyframes fadeInMessage { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .message .avatar { width: 40px; height: 40px; background: var(--secondary-color); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; margin-right: 15px; flex-shrink: 0; border: 2px solid var(--border-color); }
        .message .message-body { display: flex; flex-direction: column; }
        .message .author { font-weight: bold; margin-right: 10px; }
        .author.rank-architect { color: var(--accent-color); }
        .author.rank-enforcer { color: var(--danger-color); }
        .author.rank-artificer, .author.rank-scribe { color: #6F86FF; }
        .author.rank-signal-corps { color: #FFB86C; }
        .author.rank-sentinel { color: #A4B2FF; }
        .author.rank-soldier { color: var(--text-color); }
        .message .timestamp { font-size: 0.8em; color: var(--text-muted-color); }
        .message .content { margin-top: 5px; line-height: 1.5; }
        .chat-input { display: flex; border-top: 1px solid var(--border-color); background-color: var(--background-color); }
        .chat-input input { flex-grow: 1; background: transparent; border: none; padding: 20px; color: var(--text-color); font-family: var(--font-family-mono); font-size: 1rem; }
        .chat-input input:focus { outline: none; }
        .chat-input button { background: var(--accent-color); border: none; color: var(--background-color); padding: 0 30px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: all var(--transition-speed) ease; }
        .chat-input button:hover { background-color: #fff; letter-spacing: 1px; }
    </style>
</head>
<body>

<div id="antechamber">
    <div class="login-box">
        <h1>[ S ]</h1>
        <p id="login-prompt">Community Protocol Access</p>
        
        <div class="form-group">
            <input type="text" id="usernameInput" placeholder="ENTER YOUR ALIAS" autocomplete="username">
        </div>
        <div class="form-group">
            <input type="password" id="passwordInput" placeholder="ENTER PASSWORD" autocomplete="current-password">
        </div>
        <div class="form-group" id="repeatPasswordGroup" style="display: none;">
            <input type="password" id="repeatPasswordInput" placeholder="REPEAT PASSWORD" autocomplete="new-password">
        </div>
        <div class="form-group" id="inviteCodeGroup" style="display: none;">
            <input type="password" id="inviteCodeInput" placeholder="ENTER INVITATION CODE">
        </div>

        <button id="enterSyndicateBtn">INITIALIZE</button>
        <div id="login-error"></div>
        <div class="login-toggle">
            <a href="#" id="showRegisterLink">New Operative?</a>
            <a href="#" id="showLoginLink" style="display: none;">Existing Member Login</a>
        </div>
    </div>
</div>

<!-- The rest of the page structure is identical to the original -->
<aside id="sidebar">
    <div class="logo">S</div>
    <nav>
        <ul>
            <li class="nav-link active" data-view="mission-control"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18.7 8a6 6 0 0 0-8.4-8.4"/><path d="M13 10.7a6 6 0 0 0-8.4 8.4"/></svg></span><span class="nav-text">Mission Control</span></li>
            <li class="nav-link" data-view="lounge"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span><span class="nav-text">The Lounge</span></li>
            <li class="nav-link" data-view="armoury"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3c-1.2 0-2.4.6-3 1.7A3.5 3.5 0 0 0 5 6.8V12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V6.8a3.5 3.5 0 0 0-4-5.1A3.5 3.5 0 0 0 12 3z"/><path d="M12 13v8"/><path d="M6 13v-1a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1"/></svg></span><span class="nav-text">The Armoury</span></li>
            <li class="nav-link" data-view="proving-ground"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg></span><span class="nav-text">Proving Ground</span></li>
            <li class="nav-link" data-view="protocol"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg></span><span class="nav-text">The Protocol</span></li>
            <li class="nav-link" data-view="members"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></span><span class="nav-text">Member Roster</span></li>
            <li class="nav-link" data-view="about"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg></span><span class="nav-text">About</span></li>
        </ul>
    </nav>
    <div class="user-profile"><div class="user-details"><div id="usernameDisplay" class="username">ALIAS</div><div id="rankDisplay"><span class="rank soldier">SOLDIER</span></div><div id="status">ONLINE</div></div></div>
</aside>
<main id="main-content">
    <div id="invite-code-widget"><span>INVITE: <strong id="invite-code-text">SYN2025</strong></span><button id="copy-invite-btn" title="Copy Invite Code"><span class="copy-text">Copy</span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button></div>
    <section id="lounge" class="view"><div class="lounge-container"><div class="channel-list"><h3>Channels</h3><ul id="channels"><li class="active" data-channel="general">general</li><li data-channel="operations">operations</li><li data-channel="intel-drops">intel-drops</li><li data-channel="proof-of-work">proof-of-work</li></ul></div><div class="chat-area"><div class="chat-header">Messages in <span id="current-channel-name">#general</span></div><div class="chat-messages"></div><div id="typing-indicator"></div><form class="chat-input" id="chat-form"><input type="text" id="chatMessageInput" placeholder="Transmit in #general..." autocomplete="off"><button id="sendMessageBtn">SEND</button></form></div></div></section>
    <!-- Placeholder for other sections, which are unchanged -->
</main>

<script src="/socket.io/socket.io.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE ---
    let user = { alias: 'ALIAS', rank: 'soldier' };
    let accessMode = 'login'; // 'login' or 'register'
    let socket;
    
    // --- DOM ELEMENTS ---
    const antechamber = document.getElementById('antechamber');
    const enterBtn = document.getElementById('enterSyndicateBtn');
    const usernameInput = document.getElementById('usernameInput');
    const passwordInput = document.getElementById('passwordInput');
    const repeatPasswordGroup = document.getElementById('repeatPasswordGroup');
    const repeatPasswordInput = document.getElementById('repeatPasswordInput');
    const inviteCodeGroup = document.getElementById('inviteCodeGroup');
    const inviteCodeInput = document.getElementById('inviteCodeInput');
    const usernameDisplay = document.getElementById('usernameDisplay');
    const rankDisplay = document.getElementById('rankDisplay');
    const loginError = document.getElementById('login-error');
    const loginPrompt = document.getElementById('login-prompt');
    const showRegisterLink = document.getElementById('showRegisterLink');
    const showLoginLink = document.getElementById('showLoginLink');

    // Chat elements
    const chatForm = document.getElementById('chat-form');
    const chatMessages = document.querySelector('.chat-messages');
    const messageInput = document.getElementById('chatMessageInput');
    const channelList = document.getElementById('channels');
    const currentChannelName = document.getElementById('current-channel-name');
    const typingIndicator = document.getElementById('typing-indicator');
    let currentChannel = 'general';
    let typingTimeout;

    // --- FUNCTIONS ---

    const setAccessMode = (mode) => {
        accessMode = mode;
        loginError.textContent = '';
        if (mode === 'register') {
            loginPrompt.textContent = 'Register New Operative';
            usernameInput.placeholder = 'CHOOSE YOUR ALIAS';
            enterBtn.textContent = 'REGISTER';
            repeatPasswordGroup.style.display = 'block';
            inviteCodeGroup.style.display = 'block';
            showRegisterLink.style.display = 'none';
            showLoginLink.style.display = 'inline';
        } else { // login
            loginPrompt.textContent = 'Community Protocol Access';
            usernameInput.placeholder = 'ENTER YOUR ALIAS';
            enterBtn.textContent = 'INITIALIZE';
            repeatPasswordGroup.style.display = 'none';
            inviteCodeGroup.style.display = 'none';
            showRegisterLink.style.display = 'inline';
            showLoginLink.style.display = 'none';
        }
    };

    const showError = (message) => {
        loginError.textContent = message;
    };

    const proceedToHub = (userData) => {
        user = userData; // Set the global user object
        usernameDisplay.textContent = user.alias;
        rankDisplay.innerHTML = `<span class="rank ${user.rank.replace(' ', '-')}">${user.rank.toUpperCase()}</span>`;
        antechamber.style.opacity = '0';
        setTimeout(() => { antechamber.style.display = 'none'; }, 500);
        
        // This is now the single point of chat initialization
        initializeChat(); 
        socket.emit('user joined', user);
    };

    const handleAccess = () => {
        if (!socket) {
             socket = io();
             setupSocketListeners();
        }

        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();
        
        // Basic client-side validation
        if (username === '' || password === '') {
            return showError('Alias and password cannot be empty.');
        }

        if (accessMode === 'register') {
            const repeatPassword = repeatPasswordInput.value.trim();
            const inviteCode = inviteCodeInput.value.trim();
            if (password !== repeatPassword) {
                return showError('Passwords do not match.');
            }
            if (inviteCode === '') {
                return showError('Invitation code is required.');
            }
            socket.emit('register', { username, password, inviteCode });

        } else { // login mode
            socket.emit('login', { username, password });
        }
    };

    const setupSocketListeners = () => {
        // --- Authentication Listeners ---
        socket.on('register success', (userData) => proceedToHub(userData));
        socket.on('register error', (message) => showError(message));
        socket.on('login success', (userData) => proceedToHub(userData));
        socket.on('login error', (message) => showError(message));

        // --- Chat Listeners ---
        socket.on('chat message', (msg) => {
            if (msg.channel === currentChannel) appendMessage(msg);
        });

        socket.on('channel history', (data) => {
            if (data.channel === currentChannel) {
                chatMessages.innerHTML = '';
                data.history.forEach(appendMessage);
            }
        });
        
        socket.on('typing broadcast', (typingUsers) => {
             const usersTypingInChannel = Object.values(typingUsers).filter(u => u && u.channel === currentChannel && u.username !== user.alias);
            if (usersTypingInChannel.length === 0) {
                typingIndicator.textContent = '';
            } else if (usersTypingInChannel.length === 1) {
                typingIndicator.textContent = `${usersTypingInChannel[0].username} is typing...`;
            } else {
                typingIndicator.textContent = 'Multiple users are typing...';
            }
        });
    }

    const initializeChat = () => {
        // Most of the old logic is now in setupSocketListeners.
        // This function is now just a placeholder in case we need
        // chat-specific UI setup after login.
    };

    const appendMessage = (msg) => {
        const messageHTML = `
            <div class="message">
                <div class="avatar">${msg.author.substring(0, 2).toUpperCase()}</div>
                <div class="message-body">
                    <div>
                        <span class="author rank-${msg.rank}">${msg.author}</span>
                        <span class="timestamp">${msg.timestamp}</span>
                    </div>
                    <div class="content">${msg.content}</div>
                </div>
            </div>`;
        chatMessages.insertAdjacentHTML('beforeend', messageHTML);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };
    
    // --- EVENT LISTENERS ---
    enterBtn.addEventListener('click', handleAccess);
    [usernameInput, passwordInput, repeatPasswordInput, inviteCodeInput].forEach(input => {
        input.addEventListener('keypress', (e) => e.key === 'Enter' && handleAccess());
    });
    
    showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); setAccessMode('register'); });
    showLoginLink.addEventListener('click', (e) => { e.preventDefault(); setAccessMode('login'); });

    // Initialize the socket connection as soon as the page loads,
    // so it's ready for login/register events.
    socket = io();
    setupSocketListeners();
});
</script>

</body>
</html>
